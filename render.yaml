services:
  # Web Service - Next.js Application
  - type: web
    name: performance-mgmt-web
    env: node
    region: oregon
    plan: starter
    buildCommand: npm install && npx prisma generate && npx prisma migrate deploy && npm run build
    startCommand: npm start
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: performance-mgmt-db
          property: connectionString
      - key: AUTH_SECRET
        generateValue: true
      - key: AUTH_URL
        fromService:
          type: web
          name: performance-mgmt-web
          property: host
      - key: EMAIL_PROVIDER
        value: resend
      - key: EMAIL_API_KEY
        sync: false
      - key: EMAIL_FROM
        sync: false
      - key: STORAGE_ENDPOINT
        sync: false
      - key: STORAGE_BUCKET
        sync: false
      - key: STORAGE_ACCESS_KEY
        sync: false
      - key: STORAGE_SECRET_KEY
        sync: false
      - key: STORAGE_REGION
        value: us-east-1
      - key: AI_PROVIDER
        value: openai
      - key: AI_API_KEY
        sync: false
      - key: AI_MODEL
        value: gpt-4
      - key: AI_BASE_URL
        value: https://api.openai.com/v1
      - key: APP_BASE_URL
        fromService:
          type: web
          name: performance-mgmt-web
          property: host
      - key: SESSION_MAX_AGE
        value: 21600
      - key: RATE_LIMIT_LOGIN_MAX
        value: 5
      - key: RATE_LIMIT_LOGIN_WINDOW_MS
        value: 900000
      - key: RATE_LIMIT_RESET_MAX
        value: 3
      - key: RATE_LIMIT_RESET_WINDOW_MS
        value: 3600000

  # Cron Job - Nightly Insights
  - type: cron
    name: performance-mgmt-nightly
    env: node
    region: oregon
    schedule: "0 2 * * *"
    buildCommand: npm install && npx prisma generate
    startCommand: npm run jobs:nightly
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: performance-mgmt-db
          property: connectionString
      - key: EMAIL_PROVIDER
        value: resend
      - key: EMAIL_API_KEY
        sync: false
      - key: EMAIL_FROM
        sync: false
      - key: AI_PROVIDER
        value: openai
      - key: AI_API_KEY
        sync: false
      - key: AI_MODEL
        value: gpt-4

  # Cron Job - Weekly Summary
  - type: cron
    name: performance-mgmt-weekly
    env: node
    region: oregon
    schedule: "0 9 * * 1"
    buildCommand: npm install && npx prisma generate
    startCommand: npm run jobs:weekly
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: performance-mgmt-db
          property: connectionString
      - key: EMAIL_PROVIDER
        value: resend
      - key: EMAIL_API_KEY
        sync: false
      - key: EMAIL_FROM
        sync: false
      - key: APP_BASE_URL
        fromService:
          type: web
          name: performance-mgmt-web
          property: host

databases:
  - name: performance-mgmt-db
    databaseName: performance_mgmt
    plan: starter
    region: oregon
